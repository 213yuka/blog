---
title: VM複製方法について part.2/3 一般化したイメージからVMを複製する手順
date: 2021-3-01 17:30:00
tags:
  - VM
  - Windows
  - Linux
  - HowTo
---

こんにちは、Azure テクニカル サポート チームの富田です。  
今回は一般化したイメージからVMを複製する手順について、  
Azureポータル上での手順をスクリーンショット付きで詳細に説明したいと思います。  

本記事は3部作の2記事目です。  

 1. VM複製方法について 
 2. 一般化したイメージからVMを複製する手順 (←ｲﾏｺｺ)
 3. OSディスクのスナップショットから複製する手順

そのため1記事目の <a href="../vm-replica-1">VM複製方法について</a> をご覧いただいている前提で記載させていただきます。  
本記事ではAzureポータルで、一般化したイメージを使用し、
 - マネージドディスクVM から マネージドディスクVMを複製
 - アンマネージドディスクVM から マネージドディスクVMを複製
する方法を詳細に記載します。

一般化をするにあたり、下記の点についてはバックアップが無い場合取り返しがつきませんのでご注意ください。
 - 一般化を行うとマシン固有のファイルとデータは削除されます
 - 一般化を行ったVMは起動できなくなります

# 大まかな流れ

1. 複製元となるVMを作成する
2. 作成したVMで必要なソフトウェアのインストールや設定を行う
3. VMを一般化（マシン固有のファイルとデータを削除）する
4. 一般化したVMより [イメージ] を作成する
5. 作成した [イメージ] より新規VMを必要な数だけ作成する

# 実際の手順

それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。  
Windows / Linux の違いや、複製元が マネージドディスク / アンマネージドディスク の違いで、  
多少手順は変わりますが、基本的には同じような形になりますので、  
手順に違いがある場合は都度記載します。  

## 1.複製元となるVMを作成する

複製元となる仮想マシンを作成します。  
こちらは詳細な手順は割愛させていただきますので、下記資料をご参考にVMを作成ください。  

参考: クイック スタート:Azure Portal で Windows 仮想マシンを作成する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/quick-create-portal

参考: クイック スタート:Azure portal で Linux 仮想マシンを作成する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/quick-create-portal

## 2.作成したVMで必要なソフトウェアのインストールや設定を行う

VMを作成した後に、必要なソフトウェアをインストールしたり、その設定を行ってください。  
こちらは個々の要件によって変わってくるものとなりますので、お好みの形で実施ください

## 3.VMを一般化（マシン固有のファイルとデータを削除）する

ここからいよいよ本手順の肝となる、一般化を行います。  
一般化はゲストOS内部の操作で行うものとなります。  
一般化の手順は公開情報で綺麗にまとまっておりますので、一般化を行いVMをシャットダウンするところまで行いましょう。  




### 3-1.Windows VM で一般化を行う方法はこちら。

参考: Sysprep を使用して Windows VM を一般化する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep

### 注意事項: WindowsのSysprep の設定を間違えないこと！

Windowsの場合ですが、sysprep.exe を使って一般化を行いますが、  
よく最後の設定を間違えて、一般化したのにその後複製したVMがうまく起動しないということがあります。

必ず下記スクリーンショットの設定になっていることを確認してください！  
チェックボックスにチェックが入っていなかったり、再起動になっているとダメです。  
バックアップを取っていない場合、間違えると元に戻すのが難しいです。 

英語の場合:   
～～～～スクリーンショット貼る～～～～～

日本語の場合:   
～～～～スクリーンショット貼る～～～～～

### 3-2.Linux VM で一般化を行う方法はこちら。

参考: 手順 1:VM のプロビジョニングを解除する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/capture-image#step-1-deprovision-the-vm

一般化をしたらVMを停止します。  

## 4.一般化したVMより [イメージ] を作成する

それでは、ゲストOS上で一般化が完了して、VMは停止状態になりましたので、  
次に [イメージ] をAzure ポータル上で作成しましょう。  
[イメージ] をAzure ポータルで作成する手順ですが、複製元VMが  
マネージドディスク か アンマネージドディスク かで、手順が変わってきますのでそれぞれ説明しします。  

### 4-1.マネージドディスクの場合の [イメージ] 作成手順

～～～～めっちゃわかりやすい手順を書く～～～～

### 4-2.アンマネージドディスクの場合の [イメージ] 作成手順

～～～～めっちゃわかりやすい手順を書く～～～～

## 5.作成した [イメージ] より新規VMを必要な数だけ作成する

無事に [イメージ] が作成されましたので、
この [イメージ] を用いてVMを複製し放題！となります。

～～～～めっちゃわかりやすい手順を書く～～～～


