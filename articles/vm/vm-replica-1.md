---
title: VM複製方法について part.1/3 2つの方法の紹介
date: 2021-3-01 17:30:00
tags:
  - VM
  - Windows
  - Linux
  - HowTo
---

こんにちは、Azure テクニカル サポート チームの富田です。
今回はご案内することの多い、VM複製方法についてとなります。

本記事は3部作の1記事目です。
 - VM複製方法について (←ｲﾏｺｺ)
 - 一般化したイメージからVMを複製する手順
 - OSディスクのスナップショットから複製する手順

VM複製方法については多数の方法がありますが、こちらの記事では、よく使われる
 - 一般化を行いイメージを作成して、そのイメージからVMを複製する方法
 - OSディスクのスナップショットを作成し、そのスナップショットからVMを複製する方法
に絞って説明させていただきます。
また、クラシックVMについては本記事の対応範囲外となります。

まずは非常にザックリですが比較表となります。  
複製元VM / 複製先VM が マネージドディスク / アンマネージドディスク
の違いによるパターンとして下記に詳細を記載していますので合わせてご確認ください。

特に【パターン1,2,5,6】の複製先VMがマネージドディスクとなるパターンは、
今回Azureポータルでの実施手順を別記事として詳細に書いています！！！ 

|比較|一般化したイメージから複製|OSディスクのスナップショットから複製|
|-|-|-|
|用途|複数台展開したい|ユーザ情報もそのままで複製したい|
|マネージドディスク → マネージドディスク|◎<br>【パターン1】として紹介|◎<br>【パターン5】として紹介|
|アンマネージドディスク → マネージドディスク|◎<br>【パターン2】として紹介|◎<br>【パターン6】として紹介|
|アンマネージドディスク → アンマネージドディスク|〇<br>【パターン3】として紹介|〇<br>【パターン7】として紹介|
|マネージドディスク → アンマネージドディスク|△<br>【パターン4】として紹介|△<br>【パターン8】として紹介|
|リージョンを跨いだ複製|・共有イメージ ギャラリーを用いて可能|・元がアンマネージドディスクの場合は可能<br>・元がマネージドディスクの場合はVHDをエクスポートした後にストレージアカウントにアップロードする等で可能|
|データおよび元VM|・VM固有のファイルとデータは削除されます<br>・元のVMは起動不可となります|・VM固有のファイルとデータは保持されます（完全読み取りコピーとなります）<br>・元のVMは起動可能です|
|その他注意事項|・データディスクやNICはVM複製時や複製後に別途設定が必要です|・データディスクやNICはVM複製時や複製後に別途設定が必要です<br>・複製したVMはSIDやホスト名が同じになりますので、同一VNET上で元VMと複製VMを同時に起動しないようにしてください<br>・Windowsの複製したVMを運用する際にはこのスナップショットの方法は使えません|



# Windows VMを複製しようとしている方への注意喚起

重要な事なので、先に記載させていただきます。  
Windows VMを複製しそれをご利用いただく場合、基本的には「一般化したイメージから複製」いただく必要がございます。  
「スナップショットから複製」はバックアップといった用途でご利用いただけるものとなります。  

 - 参考: Windows インストールのディスク複製のための Microsoft ポリシー  
https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication
 
>＝＝＝＝＝抜粋＝＝＝＝＝  
>複製またはイメージ化された Windows インストールを展開する場合は、  
>イメージをキャプチャする前にシステム準備 (Sysprep) ツールを使用する必要があります。  
>＝＝＝＝＝＝＝＝＝＝＝＝  
 
- 参考: Azure Portal を使用して VHD から VM を作成する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal
 
>＝＝＝＝＝抜粋＝＝＝＝＝  
>複数の VM を作成する場合は、特殊化されたディスクを使用しないでください。  
>代わりに、より大規模なデプロイの場合は、イメージを作成してから、そのイメージを使用して複数の VM を作成します。  
>＝＝＝＝＝＝＝＝＝＝＝＝  

# 一般化したイメージから複製

一般化したイメージからVMを複製いただく手順は基本的に下記の流れになります。
1. 複製元となるVMを作成する
2. 作成したVMで必要なソフトウェアのインストールや設定を行う
3. VMを一般化（マシン固有のファイルとデータを削除）する
4. 一般化したVMより [イメージ] を作成する
5. 作成した [イメージ] より新規VMを必要な数だけ作成する

[一般化] について馴染みのない方もいるかと思いますので、簡単に解説させていただきます。  
OS内部で [一般化する] 作業を行っていただく必要があります。  
これは、VMを複製したりするための下準備として、マシン固有のファイルとデータを削除するものとなります。  
削除されるデータの例としては [ユーザ名] [パスワード] があります。  
[ユーザ名] [パスワード] が削除されますので、一般化したイメージからVMを作成するときに  
新しい [ユーザ名] [パスワード] を指定いただくこととなります。

なお、実運用で既にご利用いただいている環境を一般化するという形は推奨されません。  
複製用に新規に仮想マシンを作成し、そこから必要な設定をいただく形としてください。  

また、ここで重要なことを2点お伝えさせていただきます。  
 - 一般化したVMは起動不可となります。
 - 一般化したVMのディスクを用いてそのままVM作成はできません。（イメージを作成した後にVM作成をする必要があります。）

この点についてはご留意願います。  
次に、マネージドディスク・アンマネージドディスクの場合分けをしながら  
一般化したイメージからVMを複製する手順を紹介します。  

## 【パターン1】一般化したイメージから複製  (マネージドディスク → マネージドディスク)

一番多いパターンはこのパターンかと思います。  
Azureポータルを用いてこの手順を行う方法をスクリーンショット付きで詳細に記載した記事を作りましたので、
<a href="vm-replica-2">paet2記事</a>をご参照ください。  


## 【パターン2】一般化したイメージから複製  (アンマネージドディスク → マネージドディスク)

これも多いパターンかと思います。  
こちらについても同じくAzureポータルで行う方法を詳細に解説した記事を作成しましたので、  
<a href="vm-replica-2">paet2記事</a>を参照頂けますと幸いです。  


## 【パターン3】一般化したイメージから複製  (アンマネージドディスク → アンマネージドディスク)

こちらについては下記に紹介している公開資料の方法を用いることで可能となります。  
しかしながら、現在アンマネージドディスクをわざわざ使う利点はあまり無いと思いますので、  
基本的には上述の (アンマネージドディスク → マネージドディスク) の方法をご利用いただく方が良いかと思いま  す。

参考: Azure VM から非管理対象 VM イメージを作成する方法  
https://docs.microsoft.com/ja-jp/previous-versions/azure/virtual-machines/windows/sa-copy-generalized


## 【パターン4】一般化したイメージから複製  (マネージドディスク → アンマネージドディスク)

マネージドディスク をあえて アンマネージドディスク にする方法ですが、
こちらは公開情報にも無く、推奨されません。

やり方としては、一般化した後のディスクを一度ローカルにVHDとしてエクスポートした後に、
ストレージアカウントにVHDをアップロードし、そのVHDからPowerShellでアンマネージドディスクのVMを作成。
という手順が考えられますが、わざわざアンマネージドディスクにする必要も無いと思いますので、
ここでは割愛させていただきます。

# OSディスクのスナップショットから複製

一般化したイメージからVMを複製いただく手順は基本的に下記の流れになります。

	1. 複製元となるVMを用意する
	2. VMを停止 (割り当て解除) し、OSディスクの [スナップショット] を取得
	3. 作成した [スナップショット] より必要な数だけ [ディスク] を作成
	4. 作成した [ディスク] よりVM作成する

スナップショットからの複製でご注意いただきたい点として、   
スナップショットはVM固有のファイルとデータは保持される、OSディスクの完全読み取りコピーであるということです。  
つまり、複製したVMはSIDやホスト名が複製元と同じになります。  
そのため、意図しない動作を防止するため、同一VNET上で元VMと複製VMを同時に起動しないようにしてください。  
スナップショットからの複製する場合は別のVNET上にデプロイするようにお願いいたします。  

## 【パターン5】OSディスクのスナップショットから複製  (マネージドディスク → マネージドディスク)

一番多いパターンはこのパターンかと思います。  
Azureポータルを用いてこの手順を行う方法をスクリーンショット付きで詳細に記載した記事を作りましたので、
<a href="vm-replica-3">part3記事</a>をご参照ください。  

## 【パターン6】OSディスクのスナップショットから複製  (アンマネージドディスク → マネージドディスク)

これも多いパターンかと思います。  
こちらについても同じくAzureポータルで行う方法を詳細に解説した記事を作成しましたので、  
<a href="vm-replica-3">part3記事</a>を参照頂けますと幸いです。  


## 【パターン7】OSディスクのスナップショットから複製  (アンマネージドディスク → アンマネージドディスク)

こちらについては古い記事とはなりますが公開資料の方法を用いることで可能となります。  
しかしながら、現在アンマネージドディスクをわざわざ使う利点はあまり無いと思いますので、  
基本的には上述の (アンマネージドディスク → マネージドディスク) の方法をご利用いただく方が良いかと思います。  

参考: 特殊化 VHD ファイルから ARM 環境へ仮想マシンをデプロイする Azure PowerShell  
https://docs.microsoft.com/ja-jp/archive/blogs/jpaztech/deployfromspecializedvhd-powershell


## 【パターン8】OSディスクのスナップショットから複製  (マネージドディスク → アンマネージドディスク)

マネージドディスク をあえて アンマネージドディスク にする方法ですが、  
こちらは公開情報にも無く、推奨されません。  

やり方としては、複製元のVMのディスクを一度ローカルにVHDとしてエクスポートした後に、  
ストレージアカウントにVHDをアップロードし、そのVHDからPowerShellでアンマネージドディスクのVMを作成。  
という手順が考えられますが、わざわざアンマネージドディスクにする必要も無いと思いますので、  
ここでは割愛させていただきます。  

# 別のリージョンへのVM複製

## 一般化したイメージから別リージョンへVMを複製する方法

作成いただいた [イメージ] に関しては、そのままでは、その [イメージ] が保存されているリージョンにしか、  
新しいVMをデプロイすることができません。  
また、[イメージ] 自体をリージョン間コピーすることは現時点でサポートされておりません。  

しかしながら、[共有イメージ ギャラリー] に [イメージ] を登録することにより、  
別のリージョンに対してもVMをデプロイすることが可能となります。  
[共有イメージ ギャラリー] に関しては下記の公開資料をご覧ください。  

参考: 共有イメージ ギャラリーの概要  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/shared-image-galleries

## OSディスクのスナップショットから別リージョンへの複製

こちらに関しても、現時点では [ディスク] や [スナップショット] を  
リージョン間コピーすることが叶いませんので、ひと工夫する必要があります。  

具体的にはVHDをデプロイ先のリージョンにあるストレージアカウントに保存した後、  
そこから [ディスク] を作成するといった手順が必要になります。  

別リージョンのストレージアカウントに、VHDを保存する方法ですが  
 - 複製元VMがアンマネージドディスクの場合はazcopyを用いて直接VHDをコピーする。
 - 複製元VMがマネージドディスクの場合は、[ディスク] のエクスポートでローカルに保存し、それをアップロードする。  

といった手順が必要になります。





