---
title: VM複製方法について part.1/3 2つの方法の紹介
date: 2021-3-01 17:30:00
tags:
  - VM
  - Windows
  - Linux
  - HowTo
---

こんにちは、Azure テクニカル サポート チームの富田です。
今回はご案内することの多い、VM複製方法についてとなります。

本記事は3部作の1記事目です。
 1. VM複製方法について 2つの方法の紹介
 2. 一般化したイメージからVMを複製する手順
 3. OSディスクのスナップショットからVMを複製する手順

VM複製方法については多数の方法がありますが、こちらの記事では、よく使われる
 - 一般化を行いイメージを作成して、そのイメージからVMを複製する方法
 - OSディスクのスナップショットを作成し、そのスナップショットからVMを複製する方法
に絞って説明させていただきます。  

また、こちらの記事ではマネージドディスクの使用を前提とさせていただきますので、  
アンマネージドディスクをご利用いただいている場合は、  
はじめに、下記手順でVMをマネージドディスクに変換をお願いいたします。

- Azure VM を Azure Managed Disks に移行する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/migrate-to-managed-disks

詳細な手順は、part2 / part3 に記載いたしますので、
まずは注意喚起および、それぞれの簡単な概要に触れましょう。

# Windows VMを複製しようとしている方への注意喚起

重要な事のため、先に記載させていただきます。  
**<font color="red">Windows VMを複製しそれをご利用いただく場合、基本的には「一般化したイメージからVMを複製」いただく必要がございます。</font>**   
Windows VMの場合「OSディスクのスナップショットからVMを複製」はバックアップ用途等でご利用いただけるものとなります。  

- 参考: Windows インストールのディスク複製のための Microsoft ポリシー  
https://docs.microsoft.com/ja-jp/troubleshoot/windows-server/backup-and-storage/windows-installations-disk-duplication
 
>＝＝＝＝＝抜粋＝＝＝＝＝  
>複製またはイメージ化された Windows インストールを展開する場合は、  
>イメージをキャプチャする前にシステム準備 (Sysprep) ツールを使用する必要があります。  
>＝＝＝＝＝＝＝＝＝＝＝＝  
 
- 参考: Azure Portal を使用して VHD から VM を作成する  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal
 
>＝＝＝＝＝抜粋＝＝＝＝＝  
>複数の VM を作成する場合は、特殊化されたディスクを使用しないでください。  
>代わりに、より大規模なデプロイの場合は、イメージを作成してから、そのイメージを使用して複数の VM を作成します。  
>＝＝＝＝＝＝＝＝＝＝＝＝  

# 一般化したイメージからVMを複製

こちらの手順では、一般化（VM内の固有のファイルやデータを削除）した後に、  
イメージを作成し、そのイメージから新規にVMを作成(複製)いただくこととなります。

一般化したイメージからVMを複製いただく手順は基本的に下記の流れになります。
1. 複製元となるVMを作成する
2. 作成したVMで必要なソフトウェアのインストールや設定を行う
3. VMを一般化（マシン固有のファイルとデータを削除）する
4. 一般化したVMより [イメージ] を作成する
5. 作成した [イメージ] より新規VMを必要な数だけ作成する

一般化について、あまり聞き馴染みのない方もいるかと思いますので、簡単に解説させていただきます。  
一般化とは、VMを複製したりするための下準備として、マシン固有のファイルとデータを削除するものとなります。  
削除されるデータの例として、ユーザ情報や SID (Security Identifier)があります。  

つまり、これらの情報は削除されていますので、イメージから新しくVMを作成(複製)する際に、  
新しいユーザ情報を設定し、SIDも新規に割り振られるということとなります。

また、ここで注意すべき点として、**<font color="red">一般化したVMは起動不可となるため再利用不可</font>**   
となる点についてお気を付けください。

なお、Windows VMでは一般化をする際Sysprepというツールを用います。  
そのため [一般化する] = [Sysprepを行う] と同義で使われることも多いです。

# OSディスクのスナップショットからVMを複製

一般化したイメージからVMを複製いただく手順は基本的に下記の流れになります。

	1. 複製元となるVMを用意する
	2. VMを停止 (割り当て解除) し、OSディスクの [スナップショット] を取得
	3. 作成した [スナップショット] より必要な数だけ [ディスク] を作成
	4. 作成した [ディスク] よりVM作成する

スナップショットからの複製でご注意いただきたい点として、   
スナップショットはVM固有のファイルとデータは保持される、OSディスクの完全読み取りコピーである点がございます。
つまり、複製したVMはSIDやホスト名が複製元と同じになります。  
そのため、意図しない動作を防止するため、同一VNET上で元VMと複製VMを同時に起動しないようにしてください。  
スナップショットからの複製する場合は別のVNET上にデプロイするようにお願いいたします。  

# 別のリージョンへのVM複製

## 一般化したイメージから別リージョンへVMを複製する方法

作成いただいた [イメージ] に関しては、そのままでは、その [イメージ] が保存されているリージョンにしか、  
新しいVMをデプロイすることができません。  
また、[イメージ] 自体をリージョン間コピーすることは現時点でサポートされておりません。  

しかしながら、[共有イメージ ギャラリー] に [イメージ] を登録することにより、  
別のリージョンに対してもVMをデプロイすることが可能となります。  
[共有イメージ ギャラリー] に関しては下記の公開資料をご覧ください。  

参考: 共有イメージ ギャラリーの概要  
https://docs.microsoft.com/ja-jp/azure/virtual-machines/shared-image-galleries

## OSディスクのスナップショットから別リージョンへの複製

こちらに関しても、現時点では [ディスク] や [スナップショット] を  
リージョン間コピーすることが叶いませんので、ひと工夫する必要があります。  

具体的にはVHDをデプロイ先のリージョンにあるストレージアカウントに保存した後、  
そこから [ディスク] を作成するといった手順が必要になります。  

別リージョンのストレージアカウントに、VHDを保存する方法ですが  
 - 複製元VMがアンマネージドディスクの場合はazcopyを用いて直接VHDをコピーする。
 - 複製元VMがマネージドディスクの場合は、[ディスク] のエクスポートでローカルに保存し、それをアップロードする。  

といった手順が必要になります。





